{% extends 'base.html' %} {% block title %} – Novo Post{% endblock %} 
{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-10">
    <div class="bg-white rounded shadow-sm p-4 p-md-5">
      <h1 class="display-6 fw-bold mb-4">
        <i class="fa-solid fa-circle-plus"></i>
        Criar Novo Post
      </h1>

      <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}

        <!-- Título -->
        <div class="mb-4">
          <label
            for="{{ form.titulo.id_for_label }}"
            class="form-label fw-semibold"
            >{{ form.titulo.label }} <span class="text-danger">*</span></label
          >
          {{ form.titulo }} {% if form.titulo.errors %}
          <div class="text-danger small mt-1">{{ form.titulo.errors }}</div>
          {% endif %}
        </div>

        <!-- Slug -->
        <div class="mb-4">
          <label
            for="{{ form.slug.id_for_label }}"
            class="form-label fw-semibold"
            >{{ form.slug.label }}</label
          >
          <small class="text-muted d-block mb-2"
            >Deixe em branco para gerar automaticamente do título</small
          >
          {{ form.slug }} {% if form.slug.errors %}
          <div class="text-danger small mt-1">{{ form.slug.errors }}</div>
          {% endif %}
        </div>

        <!-- Categoria e Tags -->
        <div class="row mb-4">
          <div class="col-md-6">
            <label class="form-label fw-semibold"
              >{{ form.categoria.label }}</label
            >
            {{ form.categoria }} {% if form.categoria.errors %}
            <div class="text-danger small mt-1">
              {{ form.categoria.errors }}
            </div>
            {% endif %}
          </div>
          <div class="col-md-6">
            <label
              for="{{ form.tags.id_for_label }}"
              class="form-label fw-semibold"
              >{{ form.tags.label }}</label
            >
            <small class="text-muted d-block mb-2"
              >Mantenha Ctrl (Cmd no Mac) pressionado para selecionar
              múltiplas</small
            >
            {{ form.tags }} {% if form.tags.errors %}
            <div class="text-danger small mt-1">{{ form.tags.errors }}</div>
            {% endif %}
          </div>
        </div>

        <!-- Nova Tag -->
        <div class="mb-4">
          <label
            for="{{ form.nova_tag.id_for_label }}"
            class="form-label fw-semibold"
            >{{ form.nova_tag.label }}</label
          >
          <div class="input-group">
            {{ form.nova_tag }}
            <button
              type="button"
              class="btn btn-outline-success"
              id="btn-add-tag"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                fill="currentColor"
                class="bi bi-plus-lg"
                viewBox="0 0 16 16"
              >
                <path
                  fill-rule="evenodd"
                  d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"
                />
              </svg>
              Adicionar Tag
            </button>
          </div>
          <small class="text-muted d-block mt-2"
            >{{ form.nova_tag.help_text }}</small
          >
          {% if form.nova_tag.errors %}
          <div class="text-danger small mt-1">{{ form.nova_tag.errors }}</div>
          {% endif %}
          <div id="tags-preview" class="mt-3"></div>
        </div>

        <!-- Nova Categoria -->
        <div class="mb-4">
          <label
            for="{{ form.nova_categoria.id_for_label }}"
            class="form-label fw-semibold"
            >{{ form.nova_categoria.label }}</label
          >
          <div class="input-group">
            {{ form.nova_categoria }}
            <button
              type="button"
              class="btn btn-outline-success"
              id="btn-add-categoria"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                fill="currentColor"
                class="bi bi-plus-lg"
                viewBox="0 0 16 16"
              >
                <path
                  fill-rule="evenodd"
                  d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"
                />
              </svg>
              Adicionar Categoria
            </button>
          </div>
          <small class="text-muted d-block mt-2"
            >{{ form.nova_categoria.help_text }}</small
          >
          {% if form.nova_categoria.errors %}
          <div class="text-danger small mt-1">
            {{ form.nova_categoria.errors }}
          </div>
          {% endif %}
        </div>

        <!-- Imagem -->
        <div class="mb-4">
          <label
            for="{{ form.imagem.id_for_label }}"
            class="form-label fw-semibold"
            >{{ form.imagem.label }}</label
          >
          {{ form.imagem }} {% if form.imagem.errors %}
          <div class="text-danger small mt-1">{{ form.imagem.errors }}</div>
          {% endif %}
        </div>

        <!-- Conteúdo -->
        <div class="mb-4">
          <label
            for="{{ form.conteudo.id_for_label }}"
            class="form-label fw-semibold"
            >{{ form.conteudo.label }} <span class="text-danger">*</span></label
          >
          {{ form.conteudo }} {% if form.conteudo.errors %}
          <div class="text-danger small mt-1">{{ form.conteudo.errors }}</div>
          {% endif %}
        </div>

        <!-- Data de Publicação -->
        <div class="mb-4">
          <label class="form-label fw-semibold"
            >{{ form.publicado_em.label }}</label
          >
          <small class="text-muted d-block mb-2"
            >Deixe em branco para salvar como rascunho. Preencha para publicar
            imediatamente.</small
          >
          {{ form.publicado_em }} {% if form.publicado_em.errors %}
          <div class="text-danger small mt-1">
            {{ form.publicado_em.errors }}
          </div>
          {% endif %}
        </div>

        <!-- Botões -->
        <div class="d-flex gap-3 justify-content-end">
          <a href="/usuario/" class="btn btn-outline-secondary btn-lg"
            >Cancelar</a
          >
          <button
            type="submit"
            name="salvar_rascunho"
            class="btn btn-warning btn-lg"
          >
            <i class="fa-solid fa-arrow-up-from-bracket"></i>
            Salvar como Rascunho
          </button>
          <button type="submit" name="publicar" class="btn btn-primary btn-lg">
            <i class="fa-solid fa-share-from-square"></i>
            Publicar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Pré-selecionar data e hora quando a página carrega
  function setCurrentDateTime() {
    const dataField = document.querySelector('input[name="publicado_em"]');
    if (dataField && !dataField.value) {
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      dataField.value = now.toISOString().slice(0, 16);
    }
  }

  // Chamar quando o DOM estiver pronto
  document.addEventListener("DOMContentLoaded", setCurrentDateTime);

  // Auto-gerar slug do título
  document
    .getElementById("{{ form.titulo.id_for_label }}")
    .addEventListener("input", function (e) {
      const slugField = document.getElementById("{{ form.slug.id_for_label }}");
      if (!slugField.value) {
        slugField.value = e.target.value
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/^-+|-+$/g, "");
      }
    });

  // Gerenciar nova tag
  const novaTagInput = document.getElementById(
    "{{ form.nova_tag.id_for_label }}"
  );
  const btnAddTag = document.getElementById("btn-add-tag");
  const tagsSelect = document.getElementById("{{ form.tags.id_for_label }}");
  const tagsPreview = document.getElementById("tags-preview");

  function updateTagsPreview() {
    const selectedOptions = Array.from(tagsSelect.selectedOptions);
    tagsPreview.innerHTML = "";
    selectedOptions.forEach((option) => {
      const badge = document.createElement("span");
      badge.className = "badge bg-primary me-2 mb-2";
      badge.textContent = option.text;
      tagsPreview.appendChild(badge);
    });
  }

  // Adicionar tag ao clicarem no botão ou pressionarem Enter
  function addNewTag() {
    const tagName = novaTagInput.value.trim();
    if (!tagName) return;

    // Procurar se a tag já existe
    let tagOption = Array.from(tagsSelect.options).find(
      (opt) => opt.text.toLowerCase() === tagName.toLowerCase()
    );

    if (!tagOption) {
      // Criar nova tag via AJAX
      fetch("/api/criar-tag/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
            .value,
        },
        body: JSON.stringify({ nome: tagName }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.id) {
            // Criar nova option com o ID retornado
            tagOption = document.createElement("option");
            tagOption.text = data.nome;
            tagOption.value = data.id;
            tagsSelect.appendChild(tagOption);

            // Selecionar a tag
            tagOption.selected = true;
            novaTagInput.value = "";
            updateTagsPreview();
          }
        })
        .catch((err) => {
          console.error("Erro ao criar tag:", err);
          // Fallback: criar sem ID (será criado na view)
          tagOption = document.createElement("option");
          tagOption.text = tagName;
          tagOption.value = tagName;
          tagsSelect.appendChild(tagOption);
          tagOption.selected = true;
          novaTagInput.value = "";
          updateTagsPreview();
        });
    } else {
      // Selecionar a tag existente
      tagOption.selected = true;
      novaTagInput.value = "";
      updateTagsPreview();
    }
  }

  btnAddTag.addEventListener("click", (e) => {
    e.preventDefault();
    addNewTag();
  });

  novaTagInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      addNewTag();
    }
  });

  tagsSelect.addEventListener("change", updateTagsPreview);

  updateTagsPreview();

  const novaCategoriInput = document.getElementById(
    "{{ form.nova_categoria.id_for_label }}"
  );
  const btnAddCategoria = document.getElementById("btn-add-categoria");
  const categoriSelect = document.getElementById(
    "{{ form.categoria.id_for_label }}"
  );

  function addNewCategoria() {
    const categoriName = novaCategoriInput.value.trim();
    if (!categoriName) return;

    // Procurar se a categoria já existe
    let categoriOption = Array.from(categoriSelect.options).find(
      (opt) => opt.text.toLowerCase() === categoriName.toLowerCase()
    );

    if (!categoriOption) {
      // Criar nova categoria via AJAX
      fetch("/api/criar-categoria/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
            .value,
        },
        body: JSON.stringify({ nome: categoriName }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.id) {
            // Criar nova option com o ID retornado
            categoriOption = document.createElement("option");
            categoriOption.text = data.nome;
            categoriOption.value = data.id;
            categoriSelect.appendChild(categoriOption);

            // Selecionar a categoria
            categoriOption.selected = true;
            novaCategoriInput.value = "";
          }
        })
        .catch((err) => {
          console.error("Erro ao criar categoria:", err);
          // Fallback: criar sem ID (será criado na view)
          categoriOption = document.createElement("option");
          categoriOption.text = categoriName;
          categoriOption.value = categoriName;
          categoriSelect.appendChild(categoriOption);
          categoriOption.selected = true;
          novaCategoriInput.value = "";
        });
    } else {
      // Selecionar a categoria existente
      categoriOption.selected = true;
      novaCategoriInput.value = "";
    }
  }

  btnAddCategoria.addEventListener("click", (e) => {
    e.preventDefault();
    addNewCategoria();
  });

  novaCategoriInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      addNewCategoria();
    }
  });
</script>
{% endblock %}
