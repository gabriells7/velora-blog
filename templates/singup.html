{% extends 'base.html' %} {% block title %} – Cadastro{% endblock %} 
{% block content %}
<div class="row justify-content-center">
  <div class="col-md-6 col-lg-4">
    <div class="bg-white rounded shadow-sm p-4 p-md-5">
      <h2 class="text-center mb-4 fw-bold">Criar Conta</h2>

      {% if form.errors %}
      <div class="alert alert-danger" role="alert">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          fill="currentColor"
          class="bi bi-exclamation-triangle me-2"
          viewBox="0 0 16 16"
        >
          <path
            d="M7.938 2.016A.13.13 0 0 1 8.002 2a.13.13 0 0 1 .063.016.146.146 0 0 1 .054.057l6.857 11.667c.036.06.035.124.002.183a.163.163 0 0 1-.054.06.116.116 0 0 1-.066.017H1.146a.115.115 0 0 1-.066-.017.163.163 0 0 1-.054-.06.176.176 0 0 1 .002-.183L7.884 2.073a.147.147 0 0 1 .054-.057zm1.044-.45a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566z"
          />
          <path
            d="M7.002 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 5.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995z"
          />
        </svg>
        {% for field, errors in form.errors.items %} {% for error in errors %}
        <div>{{ error }}</div>
        {% endfor %} {% endfor %}
      </div>
      {% endif %}

      <form method="post" novalidate>
        {% csrf_token %}

        <!-- Username -->
        <div class="mb-3">
          <label
            for="{{ form.username.id_for_label }}"
            class="form-label fw-semibold"
          >
            Usuário
          </label>
          {{ form.username }} {% if form.username.errors %}
          <div class="text-danger small mt-1">{{ form.username.errors }}</div>
          {% endif %}
        </div>

        <!-- Email -->
        <div class="mb-3">
          <label
            for="{{ form.email.id_for_label }}"
            class="form-label fw-semibold"
          >
            Email
          </label>
          {{ form.email }} {% if form.email.errors %}
          <div class="text-danger small mt-1">{{ form.email.errors }}</div>
          {% endif %}
        </div>

        <!-- Password -->
        <div class="mb-3">
          <label
            for="{{ form.password1.id_for_label }}"
            class="form-label fw-semibold"
          >
            Senha
          </label>
          {{ form.password1 }} {% if form.password1.errors %}
          <div class="text-danger small mt-1">{{ form.password1.errors }}</div>
          {% endif %}
        </div>

        <!-- Password Confirmation -->
        <div class="mb-4">
          <label
            for="{{ form.password2.id_for_label }}"
            class="form-label fw-semibold"
          >
            Confirmar Senha
          </label>
          {{ form.password2 }} {% if form.password2.errors %}
          <div class="text-danger small mt-1">{{ form.password2.errors }}</div>
          {% endif %}
        </div>

        <div class="d-grid">
          <button type="submit" class="btn btn-primary btn-lg">
            <i class="fa-solid fa-user-plus"></i>
            Criar Conta
          </button>
        </div>

        <div class="text-center mt-3">
          <p class="text-muted">
            Já tem conta?
            <a href="/login/" class="text-decoration-none">Faça login</a>
          </p>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Verificar se o email já está registrado em tempo real
  const emailInput = document.getElementById("{{ form.email.id_for_label }}");
  const emailFeedback = document.createElement("div");
  emailFeedback.className = "invalid-feedback d-block mt-1";
  emailFeedback.style.display = "none";
  emailInput.parentElement.appendChild(emailFeedback);

  emailInput.addEventListener("blur", function () {
    const email = this.value.trim();
    if (!email) return;

    fetch("/api/check-email/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
          .value,
      },
      body: JSON.stringify({ email: email }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.exists) {
          emailInput.classList.add("is-invalid");
          emailFeedback.textContent = "Este email já está registrado.";
          emailFeedback.style.display = "block";
        } else {
          emailInput.classList.remove("is-invalid");
          emailFeedback.style.display = "none";
        }
      })
      .catch((err) => console.error("Erro ao verificar email:", err));
  });
</script>
{% endblock %}
